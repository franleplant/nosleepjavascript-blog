{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/page-view-counter/","result":{"data":{"site":{"siteMetadata":{"title":"NoSleep Javascript Blog"}},"markdownRemark":{"id":"5647b195-91bc-502a-8faf-67bb8284b464","excerpt":"Introduction Since we are using Gatsby to build this site as a set of static files, there are some common functionalities that you might find in dynamic sites…","html":"<h2 id=\"introduction\" style=\"position:relative;\">Introduction<a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Since we are using <a href=\"https://www.gatsbyjs.org/\">Gatsby</a> to build this site as a set of static files, there are some common functionalities that you might find in dynamic sites which you will naturally be missing. However, this does not mean they cannot be implemented in some way.</p>\n<p>As a way of testing the development of a small, simple feature and some Azure offerings, we decided to try to build a page view counter for our blog posts.</p>\n<h2 id=\"scope\" style=\"position:relative;\">Scope<a href=\"#scope\" aria-label=\"scope permalink\" class=\"header-anchor after\">#</a></h2>\n<p>The scope of this small experiment will be to build a small service that maintains the state of how many times a specific blog post (or in general, a page) was viewed. Since in our case we are building the site statically, we will be calling the service from the frontend.</p>\n<h2 id=\"tech-requirements\" style=\"position:relative;\">Tech requirements<a href=\"#tech-requirements\" aria-label=\"tech requirements permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Azure provides <a href=\"https://docs.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-overview\">multiple compute solutions</a>, each with its own use cases. Considering the scope, <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview\">Azure Functions</a> sounds like a good offering. Function apps are serverless execution contexts where we can run a piece of code (the Functions themselves) in a stateless way.</p>\n<p>Since this compute platform is stateless, it means we’ll need to have a separate way of storing how many times each page was visited. Most of the full-fledged DB offerings will probably be overkill for this, so using something like <a href=\"https://azure.microsoft.com/en-us/services/storage/tables/\">Azure Storage Tables</a> sounds like a good idea. The light, no-schema, and cheap service is good for key-value storage, which is exactly what we need.</p>\n<p>Considering the above, what we will be using is the following:</p>\n<ul>\n<li>An Azure account/subscription (the <a href=\"https://azure.microsoft.com/en-us/free/\">free one</a> will be more than enough).</li>\n<li>Azure Storage Account, to use the tables service.</li>\n<li>Azure Functions App, to deploy our function into.</li>\n<li>An IDE (for this, I will be using .NET Core C# on the free version of <a href=\"(https://azure.microsoft.com/downloads/)\">Visual Studio</a>, but there are <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/supported-languages\">several offerings</a> that Azure Functions support)</li>\n<li>The <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local#v2\">Core Tools</a> for Azure Functions. It comes with Visual Studio if you include the <strong>Azure development</strong> workload when installing it.</li>\n</ul>\n<h2 id=\"capacity\" style=\"position:relative;\">Capacity<a href=\"#capacity\" aria-label=\"capacity permalink\" class=\"header-anchor after\">#</a></h2>\n<p>These Azure services all have their own pricing plans, but as mentioned in the above section, we will be fine using the free subscription offering for the experiment. You can see which products are free and in which capacity <a href=\"https://azure.microsoft.com/en-us/free/search#new-products\">here</a>.</p>\n<p>You can see that this plan includes 1,000,000 function requests per month, which is a good amount in terms of capacity. You can upgrade later if needed, but in general, it’s a cheap plan and a good way to start.</p>\n<h2 id=\"building-the-service\" style=\"position:relative;\">Building the service<a href=\"#building-the-service\" aria-label=\"building the service permalink\" class=\"header-anchor after\">#</a></h2>\n<h3 id=\"overview\" style=\"position:relative;\">Overview<a href=\"#overview\" aria-label=\"overview permalink\" class=\"header-anchor after\">#</a></h3>\n<p>As a general guide, let’s review a brief overview of what we’ll accomplish and delve into the details as the post goes on:</p>\n<ol>\n<li>We need to create an Azure Function.</li>\n<li>As Azure Functions are stateless, we need to add a way to persist these counts. For this, we need to create an Storage Account on Azure and use the Table service to keep track of this.</li>\n<li>We’ll have to program the Azure Function that it responds to requests for page view counts (for a specific URL/post) and tracks this on Storage Tables.</li>\n<li>Lastly, we’ll have to deploy the solution.</li>\n</ol>\n<h3 id=\"using-azure-functions\" style=\"position:relative;\">Using Azure Functions<a href=\"#using-azure-functions\" aria-label=\"using azure functions permalink\" class=\"header-anchor after\">#</a></h3>\n<p>Azure Functions is a way of executing code in a <a href=\"https://azure.microsoft.com/solutions/serverless/\">serverless</a> manner. In a way, it lets us only worry about the code that we want to execute instead of how the code is executed:</p>\n<blockquote>\n<p>Azure Functions is a solution for easily running small pieces of code, or “functions,” in the cloud. You can write just the code you need for the problem at hand, without worrying about a whole application or the infrastructure to run it. Functions can make development even more productive, and you can use your development language of choice, such as C#, Java, JavaScript, PowerShell, and Python. Pay only for the time your code runs and trust Azure to scale as needed.</p>\n</blockquote>\n<p>It’s similar to what AWS offers with Lambdas. Thinking about it in terms of abstractions, we can put Functions-as-a-Service a layer above Platform-as-a-service (which, in turn, finds itself above Infrastructure-as-a-Service).</p>\n<p>There are some things we need to define before writing code for our own function, but they will be explained as we go along with the creation of the project in Visual Studio.</p>\n<p>Note that you can also create the Azure Function before deploying any actual code into it on the Azure portal (or several other ways like PowerShell, Azure CLI, REST API, etc.), but it makes sense to abstract from that considering the fact that we know that the project templates that come with Visual Studio (or the core tools in general) handle everything we need to deploy our code correctly into our own Azure account.</p>\n<p>To start, we open Visual Studio and create a new project. In the Create a new project dialog box, search for functions, choose the Azure Functions template, and select Next. I’m creating the project with the name <em>PageViewCounter</em>.</p>\n<p>At this point, we need to set up our Function implementation. Let’s review the settings we need to set and what their concepts mean:</p>\n<ul>\n<li>There’s a drop-down that contains the technologies that will host our functions. As mentioned previously, we will use <em>Azure Functions v2 (.NET Core)</em>.</li>\n<li>Functions also provide automatic ways of triggering our code, some of which communicate with other Azure Services to call the function when something happens (Queues triggers, IoT Triggers, Blob Triggers, etc.). We’ll use the <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook?tabs=csharp\"><strong>HTTP trigger</strong></a> as we want our function to trigger whenever we enter a page.</li>\n<li>Authorization level: Anonymous. We don’t need fancy ways of doing authentication for this so we’ll leave it at that for simplicity.</li>\n</ul>\n<p>After creating the project, we are received with boilerplate code that does some simple processing of a request; where if the HTTP request contains a name parameter, the response will be a greeting, and otherwise the request will fail with an error message:</p>\n<p><strong><code class=\"language-text\">Function1.cs</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FunctionName</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Function1\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IActionResult<span class=\"token punctuation\">></span></span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">HttpTrigger</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>AuthorizationLevel<span class=\"token punctuation\">.</span>Anonymous<span class=\"token punctuation\">,</span> <span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"post\"</span><span class=\"token punctuation\">,</span> Route <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\">HttpRequest</span> req<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">ILogger</span> log<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"C# HTTP trigger function processed a request.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>Query<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> requestBody <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StreamReader</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ReadToEndAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">dynamic</span></span> data <span class=\"token operator\">=</span> JsonConvert<span class=\"token punctuation\">.</span><span class=\"token function\">DeserializeObject</span><span class=\"token punctuation\">(</span>requestBody<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        name <span class=\"token operator\">=</span> name <span class=\"token operator\">??</span> data<span class=\"token punctuation\">?.</span>name<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> name <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n            <span class=\"token punctuation\">?</span> <span class=\"token punctuation\">(</span>ActionResult<span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">OkObjectResult</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Hello, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">BadRequestObjectResult</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Please pass a name on the query string or in the request body\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let’s unpack some of the things we see here:</p>\n<ul>\n<li>The <em>[FunctionName(“Function1”)]</em> attribute tells the Azure Functions app what the name of our Function is.</li>\n<li><em>[HttpTrigger(AuthorizationLevel.Anonymous, “get”, “post”, Route = null)] HttpRequest req</em>: This attribute is used to define that this Function is triggered by HTTP and you can have it be triggered by this other things, as we reviewed. We are also telling it through a list of string params that the Function should respond to GETs and POSTs HTTP requests. You could change any of this at any point.</li>\n</ul>\n<p>There are some other files in the project that we’ll look into later.</p>\n<p>If we build and run the project, a console window opens up and gives us some information about our locally-hosted service:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Application started. Press Ctrl+C to shut down.\n\nHttp Functions:\n\n        Function1: <span class=\"token punctuation\">[</span>GET,POST<span class=\"token punctuation\">]</span> http://localhost:7071/api/Function1</code></pre></div>\n<p>If we enter that URL into a browser (or even make a request to it with <em>curl</em>) without a name parameter, it will ask us to pass a parameter name. If we do so (for instance, by entering <em><a href=\"http://localhost:7071/api/Function1?name=nacho\">http://localhost:7071/api/Function1?name=nacho</a></em>), it will say hello pertinently.</p>\n<p>We can go ahead and make our first changes to this. We should start by naming the function something more specific. For this we can change the [<em>FunctionName()</em>] attribute. I will name it <em>GetPageViewCount</em> (and, to accompany the function name, I’ll rename the function file to this as well). We would also like it to respond only to <strong>POST</strong> requests, so I will remove the <em>GET</em> parameter in the [<em>HttpTrigger()</em>] attribute. Lastly, we can change our code to return just “Hello!” as text for now. This is what it will look like:</p>\n<p><strong><code class=\"language-text\">GetPageViewCount.cs</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FunctionName</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"GetPageViewCount\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IActionResult<span class=\"token punctuation\">></span></span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">HttpTrigger</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>AuthorizationLevel<span class=\"token punctuation\">.</span>Anonymous<span class=\"token punctuation\">,</span> <span class=\"token string\">\"post\"</span><span class=\"token punctuation\">,</span> Route <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\">HttpRequest</span> req<span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">ILogger</span> log<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> requestBody <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StreamReader</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ReadToEndAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">dynamic</span></span> data <span class=\"token operator\">=</span> JsonConvert<span class=\"token punctuation\">.</span><span class=\"token function\">DeserializeObject</span><span class=\"token punctuation\">(</span>requestBody<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ActionResult<span class=\"token punctuation\">)</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">OkObjectResult</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>If we wanted, we could go ahead and publish our project by doing a right-click on the Project and selecting <strong>Publish</strong>. Here is another thing we need to define about our service: How the pricing will be performed. The easiest way, especially if we are using the free Azure account, is to use a Consumption plan, which will give us <strong>1 million</strong> free requests. There are some disadvantages compared to the other 2 plans (Premium and App Services):</p>\n<ul>\n<li>Premium hosting has nice to have features such as perpetual warm instances (as to avoid cold starts which will make our code start with a bit of latency). However, latency is not something we care about in this case.</li>\n<li>App Service hosting makes our code run on App Service VMs, which makes it optimal if you are using that service already.</li>\n</ul>\n<p>Lastly, when publishing to a consumption plan, it asks us for the following:</p>\n<ul>\n<li>Name: The name of the plan.</li>\n<li>Subscription: After authenticating with your account, your free sub will appear here.</li>\n<li>Resource group: Just a way to group resources in Azure. All resources need to be deployed into one. You will need to create a new one if you didn’t already</li>\n<li>Location: The datacenter in which you want your Function to run.</li>\n<li>Azure Storage: The plan needs to store metadata and for this, they use a storage account. You will need to create one.</li>\n</ul>\n<p>Notice that the last field is an Azure Storage Account. This is convenient for us because as we said, we will be using Storage tables and this saves us the creation of one. Let’s create the Storage Account and proceed with the publishing. A Storage Account name must be unique because it creates public endpoints through which you can access the service (e.g. <em><a href=\"https://your-storage-name.table.core.windows.net\">https://your-storage-name.table.core.windows.net</a></em>). You are charged by the data egress and ingress, so you can create as many as you want.</p>\n<p>You can also access the <a href=\"https://portal.azure.com/\">Azure Portal</a>, log in and see the resource group with the resources you just created!</p>\n<h3 id=\"using-azure-storage\" style=\"position:relative;\">Using Azure Storage<a href=\"#using-azure-storage\" aria-label=\"using azure storage permalink\" class=\"header-anchor after\">#</a></h3>\n<p>Azure Storage encompasses many services such as Blobs, Tables, Queues, Files, etc. In our case, we mentioned we will use Tables because of the easy key-value storage. We can think of a page URL as the key, and the times it was counted as the value that we want to retrieve.</p>\n<p>At this point, we want to install the Azure Storage Tables NuGet package (or the equivalent for the language you want). We are actually going to use the <a href=\"https://docs.microsoft.com/en-us/azure/cosmos-db/tutorial-develop-table-dotnet#install-the-required-nuget-package\">Cosmos DB Tables API</a>, since it includes the API for accessing storage tables.\nLet’s add the reference to it:</p>\n<p><strong><code class=\"language-text\">GetPageViewCount.cs</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Azure<span class=\"token punctuation\">.</span>Cosmos<span class=\"token punctuation\">.</span>Table</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Since we already created our account, we can easily access the Tables service through our code. What we need for this is the following:</p>\n<ul>\n<li>The <strong>connection string</strong>: This is an authentication key that you can get <a href=\"https://docs.microsoft.com/en-us/azure/cosmos-db/tutorial-develop-table-dotnet#install-the-required-nuget-package\">from the portal</a>.</li>\n<li>A <strong>Value</strong> (view count) to store and retrieve in the tables through a <strong>Key</strong> (URL).</li>\n<li>Code that connects and access the tables through the API package that we installed.</li>\n</ul>\n<p>Let us review how tables store entities work.</p>\n<h3 id=\"table-entities\" style=\"position:relative;\">Table Entities<a href=\"#table-entities\" aria-label=\"table entities permalink\" class=\"header-anchor after\">#</a></h3>\n<p>The simple way to store entities is to create a class that inherits from <code class=\"language-text\">TableEntity</code>. What this means is that the class will need to have two Properties: A <code class=\"language-text\">PartitionKey</code> and a <code class=\"language-text\">RowKey</code> . Both keys, combined, form the <strong>Key</strong> through which we will <strong>uniquely identify our entity</strong>. However, separated they serve a different purpose:</p>\n<ul>\n<li>\n<p>The <code class=\"language-text\">PartitionKey</code> defines the partition in which the service will store the entity:</p>\n<blockquote>\n<p>Tables are partitioned to support load balancing across storage nodes. A table’s entities are organized by partition. A partition is a consecutive range of entities possessing the same partition key value. The partition key is a unique identifier for the partition within a given table, specified by the PartitionKey property.</p>\n</blockquote>\n</li>\n<li>The <code class=\"language-text\">RowKey</code> is a unique identifier for an entity within a given partition.</li>\n</ul>\n<p>Since the <code class=\"language-text\">PartitionKey</code> is used for load balancing, it’s important that it’s not hardcoded. For this, we can use the URL of the page in which we are counting the views. The <code class=\"language-text\">RowKey</code> can be hardcoded, because we are already changing the key through the use of the URL in the <code class=\"language-text\">PartitionKey</code>. Eventually we could have different <code class=\"language-text\">RowKey</code> for different scenarios, but for now it will stay as a hardcoded value. You can read more <a href=\"https://docs.microsoft.com/en-us/rest/api/storageservices/understanding-the-table-service-data-model\">here</a>.</p>\n<p>After that, the entity can have whichever fields we want. Since we are storing the values, this is how our class will look:</p>\n<p><strong><code class=\"language-text\">GetPageViewCount.cs</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">  <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ViewCount</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">TableEntity</span></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token function\">ViewCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> URL<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//the partition key for load-balancing and identification</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>PartitionKey <span class=\"token operator\">=</span> URL<span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// hardcoded for identification</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>RowKey <span class=\"token operator\">=</span> <span class=\"token string\">\"visits\"</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// the value we want to store</span>\n            Count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Count <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token function\">ViewCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            Count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"changing-our-function-to-connect-to-storage\" style=\"position:relative;\">Changing our function to connect to Storage<a href=\"#changing-our-function-to-connect-to-storage\" aria-label=\"changing our function to connect to storage permalink\" class=\"header-anchor after\">#</a></h3>\n<p>We now have the entity that we want to store and retrieve, so we need to connect to Storage and do precisely that. Table entities are stored in Tables which are identified with a name, so we can choose it and connect to it through a <code class=\"language-text\">CloudTable</code> object. In general, the logic is as follows:</p>\n<ol>\n<li>Connect to the Storage Account through the connection string.</li>\n<li>Create a table client through which we do transactions (inserts, updates, etc.).</li>\n<li>Get the table through its name.</li>\n<li>Execute transactions on the table.</li>\n</ol>\n<p>Here are the first 3 steps in code:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">    <span class=\"token keyword\">const</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> tableName <span class=\"token operator\">=</span> <span class=\"token string\">\"viewcountertable\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> storageAccount <span class=\"token operator\">=</span> CloudStorageAccount<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">yourStorageAccountConnectionString</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> tableClient <span class=\"token operator\">=</span> storageAccount<span class=\"token punctuation\">.</span><span class=\"token function\">CreateCloudTableClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">CloudTable</span> table <span class=\"token operator\">=</span> tableClient<span class=\"token punctuation\">.</span><span class=\"token function\">GetTableReference</span><span class=\"token punctuation\">(</span>tableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// we can let our code create the table if needed</span>\n    <span class=\"token keyword\">await</span> table<span class=\"token punctuation\">.</span><span class=\"token function\">CreateIfNotExistsAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We can now do transactions to the table! Let’s get the URL parameter from the body first:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">    <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> requestBody <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StreamReader</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ReadToEndAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">dynamic</span></span> data <span class=\"token operator\">=</span> JsonConvert<span class=\"token punctuation\">.</span><span class=\"token function\">DeserializeObject</span><span class=\"token punctuation\">(</span>requestBody<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> pageViewURL <span class=\"token operator\">=</span> data<span class=\"token punctuation\">?.</span>URL<span class=\"token punctuation\">;</span></code></pre></div>\n<p>And now, we can use <code class=\"language-text\">URL</code> to create a <code class=\"language-text\">ViewCount</code> object that uses it as a key. The logic should be easy to follow but here’s a high-level overview:</p>\n<ol>\n<li>Try to retrieve the <code class=\"language-text\">ViewCount</code> object for the URL.</li>\n<li>If it doesn’t exist, create a new <code class=\"language-text\">ViewCount</code> object (with count 0 by default) for that URL.</li>\n<li>Increase the view count on that object by 1.</li>\n<li>Store the updated entity.</li>\n<li>Return the view count to the function caller.</li>\n</ol>\n<p>Here’s what the code looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">    <span class=\"token comment\">// try to retrieve count for the URL</span>\n     <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> retrievedResult <span class=\"token operator\">=</span> table<span class=\"token punctuation\">.</span><span class=\"token function\">Execute</span><span class=\"token punctuation\">(</span>TableOperation<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Retrieve</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ViewCount<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>pageViewURL<span class=\"token punctuation\">,</span> <span class=\"token string\">\"visits\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// wait for the operation and get the result into a ViewCount object</span>\n     <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> pageViewCount <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ViewCount<span class=\"token punctuation\">)</span> retrievedResult<span class=\"token punctuation\">.</span>Result<span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// if the entity didn't exist, create a new one with count 0</span>\n     pageViewCount <span class=\"token operator\">=</span> pageViewCount <span class=\"token operator\">??</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ViewCount</span><span class=\"token punctuation\">(</span>pageViewURL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// augment the view count by one</span>\n     pageViewCount<span class=\"token punctuation\">.</span>Count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// insert or replace the entity with the new count</span>\n     table<span class=\"token punctuation\">.</span><span class=\"token function\">Execute</span><span class=\"token punctuation\">(</span>TableOperation<span class=\"token punctuation\">.</span><span class=\"token function\">InsertOrReplace</span><span class=\"token punctuation\">(</span>pageViewCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// return the view count</span>\n     <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ActionResult<span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">OkObjectResult</span><span class=\"token punctuation\">(</span>pageViewCount<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Let’s also make sure we return an error code if we don’t give a “URL” identifier to the function before trying to retrieve an entity:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pageViewURL <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ActionResult<span class=\"token punctuation\">)</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StatusCodeResult</span><span class=\"token punctuation\">(</span><span class=\"token number\">503</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The function is now ready! Let’s make sure it works by running it locally and performing POST requests that have a “URL” parameter in the body.</p>\n<h3 id=\"deploying-and-implementation\" style=\"position:relative;\">Deploying and implementation<a href=\"#deploying-and-implementation\" aria-label=\"deploying and implementation permalink\" class=\"header-anchor after\">#</a></h3>\n<p>We are now ready to deploy the Azure Function. Something that you might want to make sure of, is that you do not usually want to keep any connection string in code, so we will be getting it through the <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-how-to-use-azure-function-app-settings#settings\">App Settings</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">  <span class=\"token comment\">// we will have a StorageConnectionString field in the app settings (local.settings.json files) where we store the storage account connection string</span>\n  <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> storageAccountConnectionString <span class=\"token operator\">=</span> Environment<span class=\"token punctuation\">.</span><span class=\"token function\">GetEnvironmentVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"StorageConnectionString\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The App Settings can be changed in the Azure Portal at runtime.</p>\n<p>Lastly, you can implement this on any page by creating a small script that calls into this function and gets the result. It would look something like this if it were in Javascript:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token string\">\"https://pageviewcounterblog.azurewebsites.net/api/GetViewCounter/\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">URL</span><span class=\"token operator\">:</span> <span class=\"token string\">\"this-blog-post-URL\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  method<span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n  body<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Success:\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Notice that this way, anyone that has access to the function endpoint can call into it. Securing the function goes beyond the scope of this post, especially because this is called in the frontend (whereas you would likely prefer to call this from the backend to authenticate properly and easily). However, something you can do pretty simply is to <a href=\"https://www.c-sharpcorner.com/article/handling-cors-in-azure-function/\">add CORS policies</a> to the function in order to have it be a little more restrictive.</p>\n<h2 id=\"closing\" style=\"position:relative;\">Closing<a href=\"#closing\" aria-label=\"closing permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Right now you should have a working Azure Function that connects to Azure Storage Table and stores the amount of times that a certain page was visited. And this was all for free (except if you exceed the million requests per month, but you can probably handle paying at that point)!</p>\n<p>This was meant to be a simple experiment that served as a good introduction to some Azure services, and to certain concepts related to computing in general. Plus, it shows a simple way in which you could extend your static sites through serverless computing.</p>\n<p>Feel free to review the code here: <a href=\"https://github.com/IgnacioAmigo/PageViewCounterBlog\">https://github.com/IgnacioAmigo/PageViewCounterBlog</a>.</p>","fields":{"slug":"/page-view-counter/","readingTime":{"text":"15 min read"}},"frontmatter":{"title":"Using Azure Functions to create a page view counter","date":"December 26, 2019","description":"We can extend static sites by creating a simple page view counter that is processed in a serverless manner, and for free. Microsoft Azure provides Functions as a flagship service to do this. Let's explore building it on Visual Studio.","tags":["azure functions","storage",".NET","cloud","serverless"],"seoFooter":null,"author":{"id":"nacho","bio":"Software Engineer with a passion on system and software architecture. Other loves include music and video games (and their development).","twitter":"ignacioamigo","github":"https://github.com/IgnacioAmigo","profilepicture":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAB2HAAAdhwGP5fFlAAAEaklEQVQ4yw3SaVMTBxgH8P0UdahHmc50xmq1QMImm2vZzbnZK7vZIyQQQsJhGsCghDOEBDVRK6MiIHKJWpyhqKjFtoCEIyFcSUACxenY9qt0Z34vnplnnnn+L/6AQ6REkXH7AnzgDh5eM/Ufm6KHht4c2p1BOtO6jrS2PaUJravb1qHrq8prqwpJaxJsXZEAbjcn8oTXzdS6cGd1FR+I052vyL4kligY48eGWFYf3UH7tpHINtyb0YUz2vCmtietkXSngVisqz10NdYfbm6pdwqWKtHsFK2CaBcau11tQ/TdHDZwgt3OWRI5U3zPeGvPEM9Kg8RwKwtEY22xWKg30tHTHaQoBCf17mrmqr+m1oFV2uCqhmbuzhr9+D965F9q+B/bo8/Mg0PswQl2/zN+/xhgBY2rxsLYkTof53JROIkGfqqZnhoeHRmI9Fz1VJE8h/lvTbjj886uscbuh5HbQ5Hh18HpvGviCyA61d56xtfI6dCLFhxiGLQj5L8Rax8fG5yaehzuaYuGryWirb1dIQhhzLj4dHz0/dzztYWXd9+fADZWWe0xxhM9NxNdtXWMGVM11Itej4226nwCcSMS6o92BIMN9+5ESd5jZTzzr2aWfp9f/TA793EXIGkVxYAOl669o/Hh4M/hSKvoMDA84jCp9sbi9/tbEzc7g02+0LW6poC3qSWYXHy/sfxu6be57OYSgBEKKwmyAsTYy/wBbnBwoNbH6i2l5ReKE17RyZtbWyq9Hq7SQfq8HMdhv85MnhzuLC68OsqnAWelmWKkS6VdUNsFRUMj5fd71Vr1uTNFdjNy/vwFRK9geY2dMzMsSrOw6MCGHt1+Mzfz99EuUF/HW6xlUnKaVQiCyskrS0pL1GoYRfUmo1kBQiYTSjEqKZ3BDJI0TLOIldR6fY6HDxKAz8swNi3LKlkeImxyzFz+1amir8+clstBCFKXg0olWCZwsAUvtzEaAlcLTIWDw6RGCA4K4HiVIOpYWsPaIbsAgsrLJaUXi78tlslBpEKPYSZZ2SU7DTO0giCUOAFZLQqOgHkSFWx6AKdkHAe6pVbyMMPJIa28AlWfKz5broC0OgTRqSkC51ikkoIqKS1mKTdZZEZTiRa+XAH/CFBMGUHIBFov0EoML6VpWKODcYIkadpTW3u9rcNTJdotMt4oZw1lJFpiRS4RllLMClagMuDtu9ln02PTk6OjI/dcnmo5pEKM5tfz75aWl1/8MrOysvHi2eT1QHVfV1NfZ1PwirO5wem/4hIFc3NLDbB/sJfL7+b3c8d/FT4VPmE0+92FH968/fBk7InRrH80/KRQOMrntySFw+xmOnmwv51Krbx8+XR29gVwcJD/c/GPZPJjZmtzcmr84qXvT589fffewMTk+DfFp3ojkVwut7+/lU6t7O6kMpm1QiGXzW5++XJU2E8BmUxydXVxZ3tD2nE8W3SmqKbGEY12jYyO8iKfSCTW1j/u7qWknxsbK2vry1tb6wsLb7J7qZnnQ/8DVjLu7TBBpHoAAAAASUVORK5CYII=","aspectRatio":1.0582010582010581,"src":"/static/bc6d8411c8c9d3487dd85b3e4e1d3db4/ee604/nacho-profile.png","srcSet":"/static/bc6d8411c8c9d3487dd85b3e4e1d3db4/69585/nacho-profile.png 200w,\n/static/bc6d8411c8c9d3487dd85b3e4e1d3db4/497c6/nacho-profile.png 400w,\n/static/bc6d8411c8c9d3487dd85b3e4e1d3db4/ee604/nacho-profile.png 800w,\n/static/bc6d8411c8c9d3487dd85b3e4e1d3db4/f3583/nacho-profile.png 1200w,\n/static/bc6d8411c8c9d3487dd85b3e4e1d3db4/756c3/nacho-profile.png 1396w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}}},"pageContext":{"slug":"/page-view-counter/","previous":{"fields":{"slug":"/gatsby-blog/"},"frontmatter":{"title":"Create a blog with Gatsby.js"}},"next":{"fields":{"slug":"/package-react-components/"},"frontmatter":{"title":"How to share React Components between Applications via NPM"}}}},"staticQueryHashes":["1000388668","1219926595","914163225"]}