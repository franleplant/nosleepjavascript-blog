{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/redux-data-fetching-antipattern/","result":{"data":{"site":{"siteMetadata":{"title":"NoSleep Javascript Blog"}},"markdownRemark":{"id":"a2137288-983e-5823-ab0a-c8f7dfebe070","excerpt":"For the longest time it has been an idiom in React applications to\nperform data fetching through Redux, this approach has always\nhave problems in its efficiency…","html":"<p>For the longest time it has been an idiom in <a href=\"https://reactjs.org/\">React</a> applications to\nperform data fetching through <a href=\"https://redux.js.org/\">Redux</a>, this approach has always\nhave problems in its efficiency and effectiveness but modern tools and techniques\nhave showed us better ways. Let’s together\nexplore what better alternatives the ecosystem has to offer, but\nfirst let’s quickly cover what’s Redux and how it is typically used\nto fetch data.</p>\n<p>Redux is a global state management system mostly associated with\nReact applications that is great for managing global app state and\nthe states transitions in a predictable way but when dealing with\napplication data fetching requirements it can become a problem:</p>\n<h2 id=\"the-typical-data-fetching-in-redux\" style=\"position:relative;\">The typical data fetching in Redux<a href=\"#the-typical-data-fetching-in-redux\" aria-label=\"the typical data fetching in redux permalink\" class=\"header-anchor after\">#</a></h2>\n<p>This is a very simplistic way to data fetch to Redux,\nit is probably not production ready and has unresolved problems.</p>\n<div class=\"gatsby-code-title code-block-title\">post.action.ts</div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">LOADING_START</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">LOADING_END</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">FETCH_ERROR</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">UPDATE</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./post.reducer\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">loadingStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token constant\">LOADING_START</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">loadingEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token constant\">LOADING_END</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">fetchError</span><span class=\"token punctuation\">(</span>error<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token constant\">FETCH_ERROR</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>post<span class=\"token operator\">:</span> IPost<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token constant\">FETCH_ERROR</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> post <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// this requires redux-thunk</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getPost</span><span class=\"token punctuation\">(</span>postId<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">loadingStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> post <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> api<span class=\"token punctuation\">.</span><span class=\"token function\">getPost</span><span class=\"token punctuation\">(</span>postId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>post<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetchError</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token function\">loadingEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title code-block-title\">post.reducer.ts</div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">LOADING_START</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts/LOADING_START\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">LOADING_END</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts/LOADING_END\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">FETCH_ERROR</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts/FETCH_ERROR\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">UPDATE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts/UPDATE\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> initialState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  loading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  error<span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  data<span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IState</span> <span class=\"token punctuation\">{</span>\n  loading<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>\n  error<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  data<span class=\"token operator\">:</span> IPost <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">postReducer</span><span class=\"token punctuation\">(</span>\n  prevState<span class=\"token operator\">:</span> IPostState <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">,</span>\n  action<span class=\"token operator\">:</span> IAction<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> IPostState <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">LOADING_START</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prevState<span class=\"token punctuation\">,</span> loading<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">LOADING_END</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prevState<span class=\"token punctuation\">,</span> loading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">FETCH_ERROR</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> error <span class=\"token operator\">=</span> action<span class=\"token punctuation\">.</span>payload<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prevState<span class=\"token punctuation\">,</span> error <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">UPDATE</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> post <span class=\"token operator\">=</span> action<span class=\"token punctuation\">.</span>payload <span class=\"token keyword\">as</span> IPost<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> postId <span class=\"token operator\">=</span> post<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prevState<span class=\"token punctuation\">,</span> data<span class=\"token operator\">:</span> post <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> prevState<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-code-title code-block-title\">root.reducer.ts</div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> post <span class=\"token keyword\">from</span> <span class=\"token string\">\"./post.reducer\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">combineReducers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> post <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And finally you can use it</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// fetch data when the component mounts</span>\n  <span class=\"token function\">onComponentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">getPost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>postId<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// or</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>postId<span class=\"token punctuation\">,</span> getPost<span class=\"token punctuation\">,</span> post<span class=\"token punctuation\">,</span> loading<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">getPost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">mapStateToProps</span><span class=\"token punctuation\">(</span>appState<span class=\"token operator\">:</span> IAppState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// reading the result of the data being fetched,</span>\n  <span class=\"token comment\">// but who asked for it? do I need to do it?</span>\n  <span class=\"token comment\">// did someone already did it?</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> post<span class=\"token punctuation\">,</span> loading<span class=\"token punctuation\">,</span> error <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> appState<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> post<span class=\"token punctuation\">,</span> loading<span class=\"token punctuation\">,</span> error <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">mapDispatchToProps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// this will be called and will trigger the http call,</span>\n  <span class=\"token comment\">// let's hope that `MyComponent` does it and does it correctly,</span>\n  <span class=\"token comment\">// i.e. in onComponentDidMount AND onComponentDidUpdate</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> getPost<span class=\"token operator\">:</span> actions<span class=\"token punctuation\">.</span>getPost <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>\n  mapStateToProps<span class=\"token punctuation\">,</span>\n  mapDispatchToProps\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>MyComponent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"data-fetching-with-redux-is-too-complicated\" style=\"position:relative;\">Data fetching with Redux is too complicated<a href=\"#data-fetching-with-redux-is-too-complicated\" aria-label=\"data fetching with redux is too complicated permalink\" class=\"header-anchor after\">#</a></h2>\n<p>The current implementation has the following problems</p>\n<ul>\n<li>it is way too verbose (hooks and libraries might make it better)</li>\n<li>is that the right semantics for my actions?</li>\n<li>is that the right structure and naming for my actions?</li>\n<li>is that the right file structure? Official Redux docs once upon a time opposed to the “ducks” approach but now they seem to <a href=\"https://redux.js.org/style-guide/style-guide#structure-files-as-feature-folders-or-ducks\">be strongly recommending it</a></li>\n<li>should I use switch or some other way of casing?</li>\n<li>should I normalize?</li>\n<li>is the state shape correct?</li>\n<li>are my meta flags correct?</li>\n<li>how would I manage multiple posts being fetched at the same time? (hint: you need to change your state shape and do more stuff)</li>\n<li>should I use <a href=\"https://github.com/immerjs/immer\">immer</a> (which I love BTW) or similar?</li>\n<li>should I use <a href=\"https://redux-toolkit.js.org\">redux-toolkit</a>?</li>\n<li>should I use <a href=\"https://redux-saga.js.org/\">sagas</a>? (which is even more verbose and complex BTW).</li>\n<li>where are the selectors?</li>\n<li>how do I make my team code consistently across the multiple action/reducers that we will need to write?</li>\n<li>what happens if more than one component triggers the same data fetching action? Do I need to dedup http calls manually?</li>\n<li>do I need to make all my data fetching actions at the root of my app? (in big enough apps this causes a bad decoupling between the data requirements of your components and your components).</li>\n<li>what about if my app is too big and I want to more granularly define what data fetching requirements a medium level component needs to have?</li>\n<li>when does this fetched data expires? how do I clean it up?</li>\n</ul>\n<p>All these are somewhat open problems that you and your team need to\nfix in the life cycle of your app development. It is really hard\nto structure this 100% correctly.</p>\n<p>And finally, these things illustrate <strong>the crazy amount of decisions, considerations and\ncode a developer needs to make in order to fetch a simple post</strong>.</p>\n<blockquote>\n<p><strong>Simple and common tasks should have simple solutions.</strong></p>\n</blockquote>\n<h2 id=\"the-usage-problem\" style=\"position:relative;\">The usage problem<a href=\"#the-usage-problem\" aria-label=\"the usage problem permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Let’s say we already figured out how to do all the boilerplate,\nwe still have to deal with the usage problem: <strong>the decoupling of the triggering of http calls\n(the action) and the reading of the result (the state)</strong> as seen in above.</p>\n<p>What you really are trying to express is something like the following,\nnotice how in a single place we have the triggering of the http side effect\nand the reading of the result and the meta data.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> result<span class=\"token punctuation\">,</span> loading<span class=\"token punctuation\">,</span> error <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getPost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// UI</span></code></pre></div>\n<div style=\"font-size: 25px; margin-top: 40px; margin-bottom: 40px;\">\n<p><strong>Decoupling things that are naturally tightly coupled is as bad as tightly coupling things that shouldn’t be.</strong></p>\n</div>\n<p>By using <code class=\"language-text\">redux</code> hooks it can, partially, get better.</p>\n<h2 id=\"redux-forces-both-data-fetching-and-mutations-to-be-imperative\" style=\"position:relative;\">Redux forces both data fetching and mutations to be imperative<a href=\"#redux-forces-both-data-fetching-and-mutations-to-be-imperative\" aria-label=\"redux forces both data fetching and mutations to be imperative permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Data fetching (when you retrieve data) is usually reactive in a React applications,\nmeaning that a prop will change, a component will render and an associated side effect\nof fetching new data should be triggered. Mutations, like saving a form are typically\nimperative. <strong>Redux forces both data fetching and mutations to be imperative</strong>.</p>\n<h2 id=\"the-library-problem\" style=\"position:relative;\">The library problem<a href=\"#the-library-problem\" aria-label=\"the library problem permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Any library that relies on Redux makes its integration surface bigger.\nLib consumers now need setup Redux and set it up the way the library expects it\nto be with the appropriate reducers and middlewares it needs to work.</p>\n<p>The alternative that we will explore are much more straight forward to encapsulate\nat the library level.</p>\n<h2 id=\"what-is-data-fetching\" style=\"position:relative;\">What is data fetching?<a href=\"#what-is-data-fetching\" aria-label=\"what is data fetching permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Let’s take a step back and analyse what we really want\nof our data fetching layer:</p>\n<ul>\n<li>dedup http calls; any “smart” component that needs data to be fetched should be able to declare it without fearing it might cause duplicated http calls.</li>\n<li>meta flags: loading, error, last fetched, etc.</li>\n<li>\n<p>updating or invalidating the <em>state</em> when necessary, example:</p>\n<ul>\n<li>when data is too old</li>\n<li>when you mutate the data in the server and you need to reflect that</li>\n</ul>\n</li>\n<li>reactivity (when a prop changes new data will be fetched if necessary).</li>\n<li>medium term response storing, reading <em>and</em> writing or updating.</li>\n<li>heavy abstraction, simplicity and a really easy to use interface.</li>\n</ul>\n<p>These things have been a staple of <a href=\"https://graphql.org/\">GraphQL</a> clients\nsuch as <a href=\"https://www.apollographql.com/\">Apollo</a> for quite some time now.</p>\n<h2 id=\"just-a-cache\" style=\"position:relative;\">Just a cache<a href=\"#just-a-cache\" aria-label=\"just a cache permalink\" class=\"header-anchor after\">#</a></h2>\n<p>When you think about it what you really want is a\n<strong>cache layer</strong> for your http requests that will simply maintain\na key value store for your data, where the <strong>key will identify\nthe <em>resource</em> and the value will be the resource plus its metadata:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> cache <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'posts/124'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* the post */</span><span class=\"token punctuation\">}</span>\n    meta<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>loading<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">,</span> lastFetched<span class=\"token punctuation\">,</span> keepAlive<span class=\"token punctuation\">,</span> etc<span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token string\">'posts/456'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* the post */</span><span class=\"token punctuation\">}</span>\n    meta<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>loading<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">,</span> lastFetched<span class=\"token punctuation\">,</span> keepAlive<span class=\"token punctuation\">,</span> etc<span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token string\">'users/barry@white.com'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* the user */</span><span class=\"token punctuation\">}</span>\n    meta<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>loading<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">,</span> lastFetched<span class=\"token punctuation\">,</span> keepAlive<span class=\"token punctuation\">,</span> etc<span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And this data structure will have the appropriate functionality on top of\nit to:</p>\n<ul>\n<li>fetch the data and store it the right key</li>\n<li>update other cache keys after a successful data fetch (i.e. after fetching multiple posts we update the individual post cache)</li>\n<li>update cache after a mutation (i.e. saving a post form)</li>\n<li>cache time: how long I want to keep this data?</li>\n<li>stale time: how long I will consider this data <em>fresh</em>?</li>\n<li>automatically managing meta flags.</li>\n</ul>\n<h2 id=\"forget-about\" style=\"position:relative;\">Forget about<a href=\"#forget-about\" aria-label=\"forget about permalink\" class=\"header-anchor after\">#</a></h2>\n<ul>\n<li>state shape (it is just a key value store of responses)</li>\n<li>no normalization (it is just a cache)</li>\n<li>data fetching meta state like loading, error, etc</li>\n<li>actions</li>\n<li>reducers</li>\n<li>thunks</li>\n<li>imperative data fetching <code class=\"language-text\">onComponentDidMount</code></li>\n</ul>\n<h2 id=\"do-this-instead\" style=\"position:relative;\">Do this instead!<a href=\"#do-this-instead\" aria-label=\"do this instead permalink\" class=\"header-anchor after\">#</a></h2>\n<p>Enter <a href=\"https://react-query.tanstack.com/\">react-query</a>.</p>\n<blockquote>\n<p>There is one alternative built on top of Redux called <a href=\"https://amplitude.github.io/redux-query/\">redux-query</a>.\nI’ve used it extensively and although it is an improvement over pure Redux,\nsome of the core problems that we covered remained.</p>\n</blockquote>\n<blockquote class=\"twitter-tweet\"><p lang=\"en\" dir=\"ltr\">removing redux after switching to react-query like <a href=\"https://t.co/JyDl8UMCHl\">pic.twitter.com/JyDl8UMCHl</a></p>&mdash; @brumm (@funkensturm) <a href=\"https://twitter.com/funkensturm/status/1321760646803968002?ref_src=twsrc%5Etfw\">October 29, 2020</a></blockquote>\n<p><code class=\"language-text\">react-query</code> is a really nice new library that builds on the things\nwe have previously discussed, solves all the problems, is\nrelatively simple and easy to understand\nand will reduce the amount of code you need to write\nfor data fetching by an absurd amount, all the previous code gets replaced by this:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useGetPost</span><span class=\"token punctuation\">(</span>postId<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> QueryResult<span class=\"token operator\">&lt;</span>IPost<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token generic-function\"><span class=\"token function\">userQuery</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>IPost<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    queryKey<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">posts/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>postId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    queryFn<span class=\"token operator\">:</span> api<span class=\"token punctuation\">.</span>getPost<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And its usage</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> postId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> post<span class=\"token punctuation\">,</span> isLoading<span class=\"token punctuation\">,</span> error <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useGetPost</span><span class=\"token punctuation\">(</span>\n    postId\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This covers what we did in Redux and more, as you can see it requires\na considerable less amount of code.</p>\n<p><strong>this is production ready!</strong></p>\n<p><code class=\"language-text\">redux-query</code> deals with a cache of responses instead of the Redux state,\nbut can do most of the same things if necessary i.e. updating the state, it just\nhave a different semantic and a much less verbose interface.</p>\n<p>There are some new problems with react-query that mostly rise from its\nreactive interface like dependent queries et al but if you know how to deal\nwith react you will know how to deal with that, and in my production experience\nthey tend to be the exception and not the rule.</p>\n<h2 id=\"tldr-try-react-query\" style=\"position:relative;\">TLDR: try react-query<a href=\"#tldr-try-react-query\" aria-label=\"tldr try react query permalink\" class=\"header-anchor after\">#</a></h2>\n<p>The programming world is an ever evolving technical landscape where\nthe community grows and learns new tips and tricks from experience,\nRedux has a historical significance and it is still suitable for certain\nscenarios but modern tools have provided better ways of doing some of the\nthings we typically used to do with Redux, data fetching is one of them.</p>\n<p>This new data fetching paradigm is mostly possible because of this\ncrazy idea the react team had: react-hooks. I agree they are\n<em>weird</em> but the new things we can build with them and the composition\nmodels they enable is really great, and I expect more awesome\nand unexpected tools like react-query to come in the near future\nas we develop our understanding of hooks.</p>\n<p>Enjoyed the ride? Consider subscribing to our awesome newsletter\nand become part of the family and consider donating and supporting my work.</p>\n<p>Cheers!</p>","fields":{"slug":"/redux-data-fetching-antipattern/","readingTime":{"text":"10 min read"}},"frontmatter":{"title":"Stop using Redux for Data Fetching, use this instead","date":"November 10, 2020","description":"Modern tools and technique have superseded using Redux for data fetching, providing a more effective and efficient solution to this problem, reducing the amount of code and decisions we need to make in order to fetch data which is common, day to day, task in modern app development.","tags":["TypeScript","Javascript","React","react-query","redux","redux-toolkit","data fetching","reactive data flow"],"seoFooter":null,"author":{"id":"franleplant","bio":"Tech Lead and Software developer with a degree in Engineering. Woodworker, all things Javascript, Rust and Software Architecture.","twitter":"franleplant","github":"https://github.com/franleplant","profilepicture":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAB2HAAAdhwGP5fFlAAACjUlEQVQ4y2P4jwH+/fsHJO/curV6xdKjhw9+//4NLogGGND4f//+BZKXL160MDVRUVLSUFZydbBbvHDBf2wAXfOfP3+AZENtjaWqVFGEx/L69HB7I3ERkUMHD8CNJmDzlo3rtrdn/Tww5/+p5Wtb8wUEBCZNnAA3GqdmiN9ePH86uTDmUG/h6vr0LT3Fdrqqpw8TYTNE89dPH84saL+3rPPlpinn5zcdn9Xw//sniDQ+zXCwdWLVqvL4iwtbTs6qPrd1KUgjqrXYNUMUndm9dk9P/obO/OkFYZeP7SVKM9DZf8GhcmDvriw/y3xvwy0tyetm9xw4fPT6tes/f/4iYDMwSJ88eRIREZ7oqDkh07cxL9HT1c3dw9va2nbv3v3IwcaAFlRv375taW0LDY2wtLZ0c7QzMzEys7T18w/KzMrOys5btmIlcmpjQNYJJFvbWgMCgyOjY3z9fH18/ULDIgoKivILimJi41NTUpOSU6/fuAm3nAE5bew9cNDR1T0qJiYkNAQIAgID0zOycnLzw8IjIyIiMzOz4uISdu3ag6IZYu3nz58mtdaWpkYFBwd4eXkFBASGhYUlJaeER0Z5eXsnJCSkpaVFRcVs2LABi+ZVyxafnVN3bUlzYrCHuZWVp6dHeHh4RGSUm7t7TEx0ampaRkYmMCw2bdqE0Ayhbt68GRcXN7+9/MrKnvq0MEtr26CgIP+AACtzE2cnR6CDMzKzkpJSQkPDb968hdAMSeuzZs92cnEODo+IiIqJjY2Ljo6JiYvPTolf3VGQnhgbGh4RFh7u6+tXXV2NHMBQzRMnTdTT03VydnRxdXVxdTMzM7GwsIgIDc5MjvPz9/f19fH29razs9+8eTNyPAMANpkgbLnsUSwAAAAASUVORK5CYII=","aspectRatio":1.1363636363636365,"src":"/static/3d0df698a9c84ca995878f7c2815d974/edb0e/franleplant-profile.png","srcSet":"/static/3d0df698a9c84ca995878f7c2815d974/69585/franleplant-profile.png 200w,\n/static/3d0df698a9c84ca995878f7c2815d974/497c6/franleplant-profile.png 400w,\n/static/3d0df698a9c84ca995878f7c2815d974/edb0e/franleplant-profile.png 620w","sizes":"(max-width: 620px) 100vw, 620px"}}}}}}},"pageContext":{"slug":"/redux-data-fetching-antipattern/","previous":{"fields":{"slug":"/why-i-love-jest/"},"frontmatter":{"title":"Jest makes unit testing fun again"}},"next":{"fields":{"slug":"/bitbucket-sucks/"},"frontmatter":{"title":"Bitbucket is developer hell"}}}},"staticQueryHashes":["1000388668","1219926595","914163225"]}